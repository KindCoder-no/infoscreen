<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tavla</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</head>
<body style="background-color: #303030;">
<div class="container-xl">
    <div class="row">
        <div class="col-4">
            <div>
            <h1 style="color: white; text-align: center;">Buss</h1>
            <br>
            <table class="table">
                <thead style="color:white;">
                <tr>
                    <th scope="col">Linje</th>
                    <th scope="col">Avgang</th>
                
                </tr>
                </thead>
                <tbody class="departures" id="departures" style="color:white;">

                </tbody>
            </table>
            </div>
            <div>
                <h1 style="color: white; text-align: center;">Neste Ferie</h1>
                <p id="countdown" style="color: white; text-align: center;"></p>
            </div>
        </div>
        <div class="col-4">
            <h1 style="color: white; text-align: center;">Chantina.no</h1>
            <br>
            <div>
                <h3 id="dagensmat" style="color: white; text-align: center;">I Dag:</h3>
            </div>
            <table class="table">
                <thead style="color:white;">
                <tr>
                    <th scope="col">Dag</th>
                    <th scope="col">Rett</th>
                    <th scope="col">Pris</th>
                </tr>
                </thead>
                <tbody class="matkalender" id="matkalender" style="color:white;">

                </tbody>
            </table>
        </div>
        <div class="col-4">
            <br>
            <h1 style="color: white; text-align: center;">Klokka</h1>
            <div>
                <h1 id="clock" style="color: white; text-align: center;">00:00</h1>
            </div>
        </div>
    </div>
</div>
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script>
        //var timeout = setInterval(sendRequest, 5000);   
        
        
        sendRequest()
        countdown()
        setClock()

        window.setInterval("reloadIFrame();", 30000);
        //window.setInterval("countdown();", 1000);

        function reloadIFrame() {
            document.frames["chantina"].location.reload();
        }

        function setClock() {
            var today = new Date();

            if(today.getMinutes() < 10){
                var minutes = "0" + today.getMinutes()
            }else{
                var minutes = today.getMinutes()
            }

            if(today.getSeconds() < 10){
                var seconds = "0" + today.getSeconds()
            }else{
                var seconds = today.getSeconds()
            }
            var clock = today.getHours() + ":" + minutes + ":" + seconds
            $('#clock').text(clock)
            setTimeout(function(){
                setClock();
            }, 100);
        }

        function countdown() {
            var today = new Date();
            //var DepartureTime = new Date("February 18, 2022");
            var ferieDate = new Date("2022", "1", "18", "15", "40");

            var timeleft = ferieDate - today;

            var days = Math.floor(timeleft / (1000 * 60 * 60 * 24));
            var hours = Math.floor((timeleft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((timeleft % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((timeleft % (1000 * 60)) / 1000);

            $('#countdown').text(days + " Dager " + hours + " Timer " + minutes + " Minutter " + seconds + " Sekunder");
            setTimeout(function(){
                countdown(); //this will send request again and again;
            }, 100);
        }

        getChantina()
        function getChantina(){
            $.ajax({
                url: "chantina",
                success: 
                function(result){
                    var idag = "I Dag: " + result.today + " (" + result.todayprice + ")"
                    var matkalender = ""

                    var matkalenderArray = result.matkalender
                    matkalenderArray.forEach(function(element, index){
                        var dager = ["Mandag", "Tirsdag", "Onsdag", "Torsdag", "Fredag"]
                        var matkalenderpriserArray = result.matkalenderprices

                        matkalender += 
                        `<tr>
                            <th scope="row">${dager[index]}</th>
                            <td>${element}</td>
                            <td>${matkalenderpriserArray[index]}</td>
                            
                        </tr>`
                    })
                    $('#matkalender').html(matkalender);
                    $('#dagensmat').html(idag); //insert text of test.php into your div
                    //console.log(result.data.stopPlace.estimatedCalls[0].destinationDisplay.frontText)
                    setTimeout(function(){
                        sendRequest(); //this will send request again and again;
                    }, 300000);
                }
            });
        }


        function sendRequest(){
            $.ajax({
                url: "departures",
                success: 
                function(result){
                    var string = ""
                    var departuresArray = result.data.stopPlace.estimatedCalls
                    var departures = departuresArray.forEach(element => {
                        element.frontText
                    })
                    for (const element of departuresArray) { 
                        string.concat(element.destinationDisplay.frontText)
                        //console.log(element.destinationDisplay.frontText);
                        var today = new Date();
                        var DepartureTime = new Date(element.expectedDepartureTime);
                        var diffMs = (DepartureTime - today); // milliseconds between now & DepartureTime
                        var diffDays = Math.floor(diffMs / 86400000); // days
                        var diffHrs = Math.floor((diffMs % 86400000) / 3600000); // hours
                        var diffMins = Math.round(((diffMs % 86400000) % 3600000) / 60000); // minutes

                        if(diffHrs === 1){
                            let hour = DepartureTime.getHours();
                            let minutes = DepartureTime.getMinutes();
                            if(minutes < 10){
                                var depTime =  hour + ":"  + "0" + minutes
                            }else{
                                var depTime =  hour + ":" + minutes
                            }
                        }else if(diffMins > 15){
                            let hour = DepartureTime.getHours();
                            let minutes = DepartureTime.getMinutes();

                            if(minutes < 10){
                                var depTime =  hour + ":" + "0" + minutes 
                            }else{
                                var depTime =  hour + ":" + minutes
                            }
                        }else if(diffMins < 1){
                            var depTime = "NÃ¥"
                        }else{
                            var depTime = diffMins + " min"
                        }

                        //var depTime = diffHrs
                        string += 
                        `<tr>
                            <th scope="row">${element.destinationDisplay.frontText}</th>
                            <td>${depTime}</td>
                            
                        </tr>`
                    }
                    console.log(result.data.stopPlace.estimatedCalls)
                    $('#departures').html(string); //insert text of test.php into your div
                    //console.log(result.data.stopPlace.estimatedCalls[0].destinationDisplay.frontText)
                    setTimeout(function(){
                        sendRequest(); //this will send request again and again;
                    }, 30000);
                }
            });
        }

        
    </script>
</body>
</html>